@{
    ViewData["Title"] = "Ödeme Yönetimi";
}

<!-- Google Fonts & Bootstrap Icons -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />
<!-- Bootstrap & DataTables stilleri -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />
<style>
    body {
        font-family: 'Inter', Arial, sans-serif;
        background: linear-gradient(120deg, #f8fafc 0%, #e0e7ef 100%);
        min-height: 100vh;
    }
    .modern-card {
        box-shadow: 0 4px 24px rgba(0,0,0,0.08), 0 1.5px 4px rgba(0,0,0,0.04);
        border-radius: 1.2rem;
        background: #fff;
        border: none;
    }
    .modern-tabs .nav-link {
        font-weight: 600;
        color: #495057;
        border-radius: 2rem;
        margin-right: 0.5rem;
        transition: background 0.2s, color 0.2s;
    }
        background: linear-gradient(90deg, #6366f1 0%, #60a5fa 100%);
        color: #fff;
        box-shadow: 0 2px 8px rgba(99,102,241,0.12);
    }
    .modern-table th {
        background: #f1f5f9;
        font-weight: 700;
        color: #374151;
    }
    .modern-table td {
        vertical-align: middle;
    }
    .modern-table tr {
        transition: background 0.2s;
    }
    .modern-table tr:hover {
        background: #f3f4f6;
    }
    .modern-badge {
        background: linear-gradient(90deg, #6366f1 0%, #60a5fa 100%);
        color: #fff;
        font-size: 1rem;
        border-radius: 1rem;
        padding: 0.4em 1em;
        margin-left: 0.5em;
    }
    .welcome-banner {
        background: linear-gradient(90deg, #6366f1 0%, #60a5fa 100%);
        color: #fff;
        border-radius: 1.2rem;
        padding: 1.5rem 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 2px 12px rgba(99,102,241,0.10);
        display: flex;
        align-items: center;
        gap: 1.2rem;
    }
    .welcome-banner i {
        font-size: 2.5rem;
        opacity: 0.85;
    }
    .summary-box {
        background: #f1f5f9;
        border-radius: 1rem;
        padding: 1rem 1.5rem;
        margin-bottom: 2rem;
        display: flex;
        gap: 2rem;
        justify-content: space-between;
        font-size: 1.1rem;
    }
    .summary-box span {
        font-weight: 600;
        color: #6366f1;
    }
    #mesaj {
        font-weight: 600;
        font-size: 1.1rem;
        margin-top: 1rem;
        text-align: center;
    }
</style>

<div class="container mt-5 mb-5">
    <div class="welcome-banner mb-4">
        <i class="bi bi-cash-coin"></i>
        <div>
            <h2 class="mb-1" style="font-weight:700;">@ViewData["Title"]</h2>
            <div style="font-size:1.1rem;opacity:0.85;">Hoş geldiniz! Şirket ödemelerinizi kolayca yönetin ve takip edin.</div>
        </div>
    </div>
    <div class="summary-box mb-4">
        <div><i class="bi bi-building"></i> Toplam Şirket: <span id="summarySirket">-</span></div>
        <div><i class="bi bi-wallet2"></i> Toplam Ödeme: <span id="summaryOdeme">-</span></div>
    </div>
    <!-- Sekmeler -->
    <ul class="nav nav-pills modern-tabs mb-3" id="tabMenu" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="liste-tab" data-bs-toggle="pill" data-bs-target="#liste" type="button" role="tab"><i class="bi bi-list-ul"></i> Tüm Ödemeler</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="microsoft-tab" data-bs-toggle="pill" data-bs-target="#microsoft" type="button" role="tab">
                <i class="bi bi-windows"></i> Microsoft
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="oracle-tab" data-bs-toggle="pill" data-bs-target="#oracle" type="button" role="tab">
                <i class="bi bi-database"></i> Oracle
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="nvidia-tab" data-bs-toggle="pill" data-bs-target="#nvidia" type="button" role="tab">
                <i class="bi bi-gpu-card"></i> Nvidia
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="ford-tab" data-bs-toggle="pill" data-bs-target="#ford" type="button" role="tab">
                <i class="bi bi-truck"></i> Ford
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="pegasus-tab" data-bs-toggle="pill" data-bs-target="#pegasus" type="button" role="tab">
                <i class="bi bi-airplane"></i> Pegasus
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="tumhaberler-tab" type="button" role="tab">
                <i class="bi bi-globe"></i> Tüm Şirketlerin Haberleri
            </button>
        </li>
    </ul>
    <div class="tab-content" id="tabContent">
        <!-- Tüm Ödemeler -->
        <div class="tab-pane fade" id="liste" role="tabpanel">
            <div class="card modern-card p-4">
                <table id="sonuclar" class="display table table-striped modern-table mt-3" style="width:100%;">
                    <thead>
                        <tr>
                            <th>Şirket Adı <span class="modern-badge"><i class="bi bi-building"></i></span></th>
                            <th>Ödenen Tutar <span class="modern-badge"><i class="bi bi-currency-lira"></i></span></th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        <!-- Şirket Sekmeleri -->
        <div class="tab-pane fade" id="microsoft" role="tabpanel">
            <div class="card modern-card p-4">
                <table id="microsoftOdemeleri" class="display table table-striped modern-table mt-3" style="width:100%;">
                    <thead><tr><th>Şirket Adı <span class="modern-badge"><i class="bi bi-building"></i></span></th><th>Ödenen Tutar <span class="modern-badge"><i class="bi bi-currency-lira"></i></span></th></tr></thead>
                    <tbody></tbody>
                </table>
                <button class="btn btn-info mt-3 sirket-haber-btn" data-sirket="Microsoft"><i class="bi bi-newspaper"></i> Haberler</button>
            </div>
        </div>
        <div class="tab-pane fade" id="oracle" role="tabpanel">
            <div class="card modern-card p-4">
                <table id="oracleOdemeleri" class="display table table-striped modern-table mt-3" style="width:100%;">
                    <thead><tr><th>Şirket Adı <span class="modern-badge"><i class="bi bi-building"></i></span></th><th>Ödenen Tutar <span class="modern-badge"><i class="bi bi-currency-lira"></i></span></th></tr></thead>
                    <tbody></tbody>
                </table>
                <button class="btn btn-info mt-3 sirket-haber-btn" data-sirket="Oracle"><i class="bi bi-newspaper"></i> Haberler</button>
            </div>
        </div>
        <div class="tab-pane fade" id="nvidia" role="tabpanel">
            <div class="card modern-card p-4">
                <table id="nvidiaOdemeleri" class="display table table-striped modern-table mt-3" style="width:100%;">
                    <thead><tr><th>Şirket Adı <span class="modern-badge"><i class="bi bi-building"></i></span></th><th>Ödenen Tutar <span class="modern-badge"><i class="bi bi-currency-lira"></i></span></th></tr></thead>
                    <tbody></tbody>
                </table>
                <button class="btn btn-info mt-3 sirket-haber-btn" data-sirket="Nvidia"><i class="bi bi-newspaper"></i> Haberler</button>
            </div>
        </div>
        <div class="tab-pane fade" id="ford" role="tabpanel">
            <div class="card modern-card p-4">
                <table id="fordOdemeleri" class="display table table-striped modern-table mt-3" style="width:100%;">
                    <thead><tr><th>Şirket Adı <span class="modern-badge"><i class="bi bi-building"></i></span></th><th>Ödenen Tutar <span class="modern-badge"><i class="bi bi-currency-lira"></i></span></th></tr></thead>
                    <tbody></tbody>
                </table>
                <button class="btn btn-info mt-3 sirket-haber-btn" data-sirket="Ford"><i class="bi bi-newspaper"></i> Haberler</button>
            </div>
        </div>
        <div class="tab-pane fade" id="pegasus" role="tabpanel">
            <div class="card modern-card p-4">
                <table id="pegasusOdemeleri" class="display table table-striped modern-table mt-3" style="width:100%;">
                    <thead><tr><th>Şirket Adı <span class="modern-badge"><i class="bi bi-building"></i></span></th><th>Ödenen Tutar <span class="modern-badge"><i class="bi bi-currency-lira"></i></span></th></tr></thead>
                    <tbody></tbody>
                </table>
                <button class="btn btn-info mt-3 sirket-haber-btn" data-sirket="Pegasus"><i class="bi bi-newspaper"></i> Haberler</button>
            </div>
        </div>
        <!-- Haberler Tablosu -->
        <div class="tab-pane fade" id="haberler" role="tabpanel">
            <div class="card modern-card p-4">
                <h4 id="haberlerBaslik" class="mb-3">Şirket Haberleri</h4>
                <table id="haberlerTablosu" class="display table table-striped modern-table mt-3" style="width:100%;">
                    <thead>
                        <tr>
                            <th>Kaynak <span class="modern-badge"><i class="bi bi-globe"></i></span></th>
                            <th>Başlık <span class="modern-badge"><i class="bi bi-newspaper"></i></span></th>
                            <th>Görsel <span class="modern-badge"><i class="bi bi-image"></i></span></th>
                            <th>İşlemler <span class="modern-badge"><i class="bi bi-link"></i></span></th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        
    </div>
</div>

<!-- JS Kütüphaneleri -->
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- SweetAlert2 CDN -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    let table, tableMicrosoft, tableOracle, tableNvidia, tableFord, tablePegasus, tableHaberler;
    let tumSirketHaberleriCache = null;
    // Özet kutusunu güncelleyen fonksiyon
    function ozetKutusuGuncelle() {
        fetch("/Home/OzetBilgi").then(res => res.json()).then(data => {
            $("#summarySirket").text(data.toplamSirket ?? "-");
            $("#summaryOdeme").text(data.toplamOdeme ?? "-");
        }).catch(()=>{});
    }
    // Şirket tabına göre şirket adını döndürür
    function getSirketAdiByTab(tabId) {
        switch(tabId) {
            case '#microsoft': return 'Microsoft';
            case '#oracle': return 'Oracle';
            case '#nvidia': return 'Nvidia';
            case '#ford': return 'Ford';
            case '#pegasus': return 'Pegasus';
            default: return null;
        }
    }
    // DataTable search inputuna Google arama event'i ekler
    function addGoogleSearchEvent(tableInstance, tabId) {
        const sirketAdi = getSirketAdiByTab(tabId);
        if (!sirketAdi) return;
        // DataTables search input'unu bul
        const searchInput = $(tableInstance.table().container()).find('input[type="search"]');
        // Önce eski eventleri kaldır
        searchInput.off('keypress.googleSearch');
        // Enter'a basıldığında Google'da arama yap
        searchInput.on('keypress.googleSearch', function(e) {
            if (e.which === 13 && this.value.trim() !== '') {
                const query = encodeURIComponent(sirketAdi + ' ' + this.value + ' haberleri');
                window.open('https://www.google.com/search?q=' + query, '_blank', 'width=900,height=700');
            }
        });
    }
    // Tüm şirketlerin haberlerini çek ve cache'le
    function tumSirketlerinHaberleriniGetirVeCachele(callback) {
        if (tumSirketHaberleriCache) {
            callback(tumSirketHaberleriCache);
            return;
        }
        fetch('/Home/TumSirketlerHaberleriGetir')
            .then(res => res.json())
            .then(data => {
                tumSirketHaberleriCache = data;
                callback(data);
            });
    }
    // Şirket sekmesinde haberleri göster
    function sirketHaberleriniGoster(sirketAdi) {
        // Önce cache'den bak
        if (tumSirketHaberleriCache && tumSirketHaberleriCache[sirketAdi] && tumSirketHaberleriCache[sirketAdi].haberler) {
            haberleriModalIleGoster(sirketAdi, tumSirketHaberleriCache[sirketAdi].haberler);
        } else {
            // Yoksa tekil endpointten çek
            fetch(`/Home/HaberBasliklariGetir?sirket=${encodeURIComponent(sirketAdi)}`)
                .then(res => res.json())
                .then(data => {
                    haberleriModalIleGoster(sirketAdi, data.haberler);
                });
        }
    }
    // Haberleri modal ile göster
    function haberleriModalIleGoster(sirket, haberlerObjesi) {
        let htmlList = '';
        if (!haberlerObjesi || Object.keys(haberlerObjesi).length === 0) {
            Swal.fire({
                icon: 'info',
                title: sirket + ' Haberleri',
                text: sirket + ' ile ilgili başlık bulunamadı.'
            });
            return;
        }
        Object.keys(haberlerObjesi).forEach(function(kaynak) {
            htmlList += `<h5 style='margin-top:1em;'>${kaynak}</h5>`;
            const basliklar = haberlerObjesi[kaynak].basliklar;
            htmlList += `<div style='display:flex;flex-wrap:wrap;gap:18px;margin-bottom:1.5em;'>`;
            basliklar.forEach(function(h) {
                if (h.baslik === 'Burada bu şirket ile ilgili haber yok') {
                    htmlList += `<div style='background:#f3f4f6;border-radius:12px;padding:24px 32px;min-width:220px;max-width:260px;display:flex;align-items:center;justify-content:center;font-weight:600;color:#888;font-size:1.05em;'>${h.baslik}</div>`;
                } else {
                    htmlList += `<div style='background:#fff;box-shadow:0 2px 12px rgba(99,102,241,0.08);border-radius:12px;padding:12px 12px 10px 12px;min-width:220px;max-width:260px;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;'>`;
                    if (h.imgSrc) {
                        htmlList += `<img src='${h.imgSrc}' alt='${h.imgAlt || ''}' style='width:100%;max-width:200px;max-height:120px;object-fit:cover;border-radius:8px 8px 0 0;margin-bottom:10px;'>`;
                    }
                    htmlList += `<div style='font-weight:600;font-size:1.05em;text-align:center;'>${h.baslik}</div>`;
                    htmlList += `</div>`;
                }
            });
            htmlList += `</div>`;
            htmlList += `<div style='margin-bottom:0.5em;'><a href='${haberlerObjesi[kaynak].url}' target='_blank' style='color:#6366f1;font-weight:600;text-decoration:underline;'>${kaynak} Kaynağına Git</a></div>`;
        });
        Swal.fire({
            icon: 'success',
            title: sirket + ' Haberleri',
            html: htmlList
        });
    }
    
    // Haberleri DataTable'a yükle
    function haberleriDataTableIleGoster(sirket, data) {
        // Önce başlığı güncelle
        $('#haberlerBaslik').text(sirket + ' Haberleri');
        
        // Eğer tablo zaten oluşturulmuşsa, yeniden oluştur
        if ($.fn.DataTable.isDataTable('#haberlerTablosu')) {
            $('#haberlerTablosu').DataTable().destroy();
        }
        
        // Tablo verilerini hazırla
        let tableData = [];
        
        if (data && data.haberler) {
            Object.keys(data.haberler).forEach(function(kaynak) {
                const basliklar = data.haberler[kaynak].basliklar;
                const kaynakUrl = data.haberler[kaynak].url;
                
                basliklar.forEach(function(h) {
                    if (h.baslik && h.baslik !== 'Burada bu şirket ile ilgili haber yok') {
                        tableData.push({
                            kaynak: kaynak,
                            baslik: h.baslik,
                            imgSrc: h.imgSrc,
                            imgAlt: h.imgAlt,
                            link: h.link,
                            kaynakUrl: kaynakUrl
                        });
                    }
                });
            });
        }
        
        // DataTable'ı oluştur
        tableHaberler = $('#haberlerTablosu').DataTable({
            data: tableData,
            columns: [
                { 
                    data: 'kaynak',
                    render: function(data, type, row) {
                        return `<strong>${data}</strong>`;
                    }
                },
                { 
                    data: 'baslik',
                    render: function(data, type, row) {
                        return data;
                    }
                },
                { 
                    data: 'imgSrc',
                    render: function(data, type, row) {
                        if (data) {
                            return `<img src="${data}" alt="${row.imgAlt || ''}" style="max-width:100px; max-height:60px;">`;
                        }
                        return '<span class="text-muted">Görsel yok</span>';
                    }
                },
                { 
                    data: null,
                    render: function(data, type, row) {
                        let buttons = '';
                        if (row.link) {
                            buttons += `<a href="${row.link}" target="_blank" class="btn btn-sm btn-primary me-1"><i class="bi bi-link"></i> Habere Git</a>`;
                        }
                        return buttons;
                    }
                }
            ],
            language: {
                url: 'https://cdn.datatables.net/plug-ins/1.13.6/i18n/tr.json'
            },
            responsive: true,
            order: [[0, 'asc']]
        });
        
        // Haberler tabına geçiş yap
        $('#tabMenu button[data-bs-target="#haberler"]').tab('show');
    }
    
    $(document).ready(function () {
        // DataTables init
        table = $('#sonuclar').DataTable({ columns: [{ data: 'sirketAd' }, { data: 'odenenTutar' }] });
        tableMicrosoft = $('#microsoftOdemeleri').DataTable({ columns: [{ data: 'sirketAd' }, { data: 'odenenTutar' }] });
        tableOracle = $('#oracleOdemeleri').DataTable({ columns: [{ data: 'sirketAd' }, { data: 'odenenTutar' }] });
        tableNvidia = $('#nvidiaOdemeleri').DataTable({ columns: [{ data: 'sirketAd' }, { data: 'odenenTutar' }] });
        tableFord = $('#fordOdemeleri').DataTable({ columns: [{ data: 'sirketAd' }, { data: 'odenenTutar' }] });
        tablePegasus = $('#pegasusOdemeleri').DataTable({ columns: [{ data: 'sirketAd' }, { data: 'odenenTutar' }] });
        
        // Haberler tablosu - boş olarak başlat
        tableHaberler = $('#haberlerTablosu').DataTable({
            columns: [
                { data: 'kaynak' },
                { data: 'baslik' },
                { data: 'imgSrc' },
                { data: null }
            ],
            language: {
                url: 'https://cdn.datatables.net/plug-ins/1.13.6/i18n/tr.json'
            }
        });
        
        // Sekmelere veri çekme
        $('button[data-bs-target="#liste"]').on('shown.bs.tab', () => {
            fetch("/Home/TumOdemeleriGetir").then(res => res.json()).then(data => {
                table.clear().rows.add(data).draw();
            });
        });
        $('button[data-bs-target="#microsoft"]').on('shown.bs.tab', () => {
            fetch("/Home/MicrosoftSirketiOdemeleri").then(res => res.json()).then(data => {
                tableMicrosoft.clear().rows.add(data).draw();
            });
            addGoogleSearchEvent(tableMicrosoft, '#microsoft');
        });
        $('button[data-bs-target="#oracle"]').on('shown.bs.tab', () => {
            fetch("/Home/OracleSirketiOdemeleri").then(res => res.json()).then(data => {
                tableOracle.clear().rows.add(data).draw();
            });
            addGoogleSearchEvent(tableOracle, '#oracle');
        });
        $('button[data-bs-target="#nvidia"]').on('shown.bs.tab', () => {
            fetch("/Home/NvidiaSirketiOdemeleri").then(res => res.json()).then(data => {
                tableNvidia.clear().rows.add(data).draw();
            });
            addGoogleSearchEvent(tableNvidia, '#nvidia');
        });
        $('button[data-bs-target="#ford"]').on('shown.bs.tab', () => {
            fetch("/Home/FordSirketiOdemeleri").then(res => res.json()).then(data => {
                tableFord.clear().rows.add(data).draw();
            });
            addGoogleSearchEvent(tableFord, '#ford');
        });
        $('button[data-bs-target="#pegasus"]').on('shown.bs.tab', () => {
            fetch("/Home/PegasusSirketiOdemeleri").then(res => res.json()).then(data => {
                tablePegasus.clear().rows.add(data).draw();
            });
            addGoogleSearchEvent(tablePegasus, '#pegasus');
        });
        // İlk açılışta tab aktif ise Google search event ekle
        if ($('#microsoft').hasClass('active show')) addGoogleSearchEvent(tableMicrosoft, '#microsoft');
        if ($('#oracle').hasClass('active show')) addGoogleSearchEvent(tableOracle, '#oracle');
        if ($('#nvidia').hasClass('active show')) addGoogleSearchEvent(tableNvidia, '#nvidia');
        if ($('#ford').hasClass('active show')) addGoogleSearchEvent(tableFord, '#ford');
        if ($('#pegasus').hasClass('active show')) addGoogleSearchEvent(tablePegasus, '#pegasus');
        // Form Yükleme
        $('#uploadForm').on('submit', function (e) {
            e.preventDefault();
            const formData = new FormData(this);
            fetch("/Home/OdemeYukleAjax", {
                method: "POST",
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                const mesajDiv = document.getElementById("mesaj");
                mesajDiv.style.color = data.success ? "#22c55e" : "#ef4444";
                mesajDiv.innerText = data.message;
                if (data.success) {
                    setTimeout(() => mesajDiv.innerText = "", 3000);
                    ozetKutusuGuncelle(); // Başarılıysa özet kutusunu güncelle
                }
            })
            .catch(() => {
                document.getElementById("mesaj").style.color = "#ef4444";
                document.getElementById("mesaj").innerText = "Bir hata oluştu.";
            });
        });
        ozetKutusuGuncelle();
    });

    // Şirket sekmelerinde haber arama ikonuna tıklanınca haberleri DataTable'da göster
    $(document).on('click', '.search-haber', function(e) {
        e.stopPropagation();
        e.preventDefault();
        const sirket = $(this).data('sirket');
        Swal.fire({
            title: 'Yükleniyor...',
            allowOutsideClick: false,
            didOpen: () => { Swal.showLoading(); }
        });
        fetch(`/Home/HaberBasliklariGetir?sirket=${encodeURIComponent(sirket)}`)
            .then(res => res.json())
            .then(data => {
                // Tablo HTML'ini oluştur
                let tableHtml = `
                    <div class="table-responsive">
                        <table id="sweetAlertHaberTable" class="display table table-striped modern-table" style="width:100%;">
                            <thead>
                                <tr>
                                    <th>Kaynak</th>
                                    <th>Başlık</th>
                                    <th>Görsel</th>
                                    <th>İşlemler</th>
                                </tr>
                            </thead>
                            <tbody>`;
                
                // Veri var mı kontrol et
                let found = false;
                
                if (data && data.haberler) {
                    Object.keys(data.haberler).forEach(function(kaynak) {
                        const basliklar = data.haberler[kaynak].basliklar;
                        const kaynakUrl = data.haberler[kaynak].url;
                        
                        // Her kaynaktan en fazla 5 haber göster
                        const MAX_HABER_PER_SOURCE = 5;
                        let haberCount = 0;
                        
                        for (let i = 0; i < basliklar.length && haberCount < MAX_HABER_PER_SOURCE; i++) {
                            const h = basliklar[i];
                            if (h.baslik && h.baslik !== 'Burada bu şirket ile ilgili haber yok') {
                                found = true;
                                tableHtml += `<tr>
                                    <td><strong>${kaynak}</strong></td>
                                    <td>${h.baslik}</td>
                                    <td>${h.imgSrc ? `<img src="${h.imgSrc}" alt="${h.imgAlt || ''}" style="max-width:80px; max-height:50px;">` : '<span class="text-muted">Görsel yok</span>'}</td>
                                    <td>
                                        ${h.link ? `<a href="${h.link}" target="_blank" class="btn btn-sm btn-primary me-1"><i class="bi bi-link"></i> Habere Git</a>` : ''}
                                        ${h.link ? `<button class="btn btn-sm btn-success haber-kaydet-btn" data-sirket="${sirket}" data-baslik="${h.baslik}" data-url="${h.link}" data-imgsrc="${h.imgSrc}"><i class="bi bi-save"></i> Ekle</button>` : ''}
                                        ${h.link ? `<button class="btn btn-sm btn-warning yapay-zeka-btn" data-sirket="${sirket}" data-baslik="${h.baslik}" data-url="${h.link}"><i class="bi bi-robot"></i> Yapay Zekaya Yorumlat!</button>` : ''}
                                    </td>
                                </tr>`;
                                haberCount++;
                            }
                        }
                    });
                }
                
                tableHtml += `
                            </tbody>
                        </table>
                    </div>`;
                
                // Hata mesajları varsa ekle
                let errorHtml = '';
                if (data && data.hatalar && Object.keys(data.hatalar).length > 0) {
                    errorHtml += '<div class="alert alert-warning mt-3">';
                    Object.keys(data.hatalar).forEach(function(kaynak) {
                        errorHtml += `<p><strong>${kaynak}:</strong> ${data.hatalar[kaynak]}</p>`;
                    });
                    errorHtml += '</div>';
                }
                
                // Sonuç yoksa mesaj göster
                if (!found) {
                    tableHtml = '<div class="alert alert-info">Bu şirket ile ilgili haber bulunamadı.</div>';
                }
                
                // SweetAlert2 ile göster
                Swal.fire({
                    icon: found ? 'success' : 'info',
                    title: sirket + ' Haberleri (Habertürk ve NTV\'den en fazla 5\'er haber)',
                    html: tableHtml + errorHtml,
                    width: '80%',
                    didOpen: () => {
                        // SweetAlert içinde DataTable'ı başlat
                        if (found) {
                            $('#sweetAlertHaberTable').DataTable({
                                language: {
                                    url: 'https://cdn.datatables.net/plug-ins/1.13.6/i18n/tr.json'
                                },
                                responsive: true,
                                paging: false,
                                searching: false,
                                ordering: true,
                                info: false,
                                lengthChange: false
                            });
                        }
                    }
                });
            })
            .catch(() => {
                Swal.fire({
                    icon: 'error',
                    title: 'Hata',
                    text: 'Haberler alınırken bir hata oluştu.'
                });
            });
    });

    // Yeni: Şirket sekmesi içindeki "Haberler" butonuna tıklanınca haberleri göster
    $(document).on('click', '.sirket-haber-btn', function() {
        const sirket = $(this).data('sirket');
        Swal.fire({
            title: 'Yükleniyor...',
            allowOutsideClick: false,
            didOpen: () => { Swal.showLoading(); }
        });
        fetch(`/Home/HaberBasliklariGetir?sirket=${encodeURIComponent(sirket)}`)
            .then(res => res.json())
            .then(data => {
                // Tablo HTML'ini oluştur
                let tableHtml = `
                    <div class="table-responsive">
                        <table id="sweetAlertHaberTable" class="display table table-striped modern-table" style="width:100%;">
                            <thead>
                                <tr>
                                    <th>Kaynak</th>
                                    <th>Başlık</th>
                                    <th>Görsel</th>
                                    <th>İşlemler</th>
                                </tr>
                            </thead>
                            <tbody>`;
                let found = false;
                if (data && data.haberler) {
                    Object.keys(data.haberler).forEach(function(kaynak) {
                        const basliklar = data.haberler[kaynak].basliklar;
                        const MAX_HABER_PER_SOURCE = 5;
                        let haberCount = 0;
                        for (let i = 0; i < basliklar.length && haberCount < MAX_HABER_PER_SOURCE; i++) {
                            const h = basliklar[i];
                            if (h.baslik && h.baslik !== 'Burada bu şirket ile ilgili haber yok') {
                                found = true;
                                tableHtml += `<tr>
                                    <td><strong>${kaynak}</strong></td>
                                    <td>${h.baslik}</td>
                                    <td>${h.imgSrc ? `<img src="${h.imgSrc}" alt="${h.imgAlt || ''}" style="max-width:80px; max-height:50px;">` : '<span class="text-muted">Görsel yok</span>'}</td>
                                    <td>
                                        ${h.link ? `<a href="${h.link}" target="_blank" class="btn btn-sm btn-primary me-1"><i class="bi bi-link"></i> Habere Git</a>` : ''}
                                        ${h.link ? `<button class="btn btn-sm btn-success haber-kaydet-btn" data-sirket="${sirket}" data-baslik="${h.baslik}" data-url="${h.link}" data-imgsrc="${h.imgSrc}"><i class="bi bi-save"></i> Ekle</button>` : ''}
                                        ${h.link ? `<button class="btn btn-sm btn-warning yapay-zeka-btn" data-sirket="${sirket}" data-baslik="${h.baslik}" data-url="${h.link}"><i class="bi bi-robot"></i> Yapay Zekaya Yorumlat!</button>` : ''}
                                    </td>
                                </tr>`;
                                haberCount++;
                            }
                        }
                    });
                }
                tableHtml += `
                            </tbody>
                        </table>
                    </div>`;
                let errorHtml = '';
                if (data && data.hatalar && Object.keys(data.hatalar).length > 0) {
                    errorHtml += '<div class="alert alert-warning mt-3">';
                    Object.keys(data.hatalar).forEach(function(kaynak) {
                        errorHtml += `<p><strong>${kaynak}:</strong> ${data.hatalar[kaynak]}</p>`;
                    });
                    errorHtml += '</div>';
                }
                if (!found) {
                    tableHtml = '<div class="alert alert-info">Bu şirket ile ilgili haber bulunamadı.</div>';
                }
                Swal.fire({
                    icon: found ? 'success' : 'info',
                    title: sirket + ' Haberleri (En fazla 5 haber)',
                    html: tableHtml + errorHtml,
                    width: '80%',
                    didOpen: () => {
                        if (found) {
                            $('#sweetAlertHaberTable').DataTable({
                                language: {
                                    url: 'https://cdn.datatables.net/plug-ins/1.13.6/i18n/tr.json'
                                },
                                responsive: true,
                                paging: false,
                                searching: false,
                                ordering: true,
                                info: false,
                                lengthChange: false
                            });
                        }
                    }
                });
            })
            .catch(() => {
                Swal.fire({
                    icon: 'error',
                    title: 'Hata',
                    text: 'Haberler alınırken bir hata oluştu.'
                });
            });
    });

    // Tüm şirketlerin haberleri butonu
    $('#tumhaberler-tab').on('click', function() {
        Swal.fire({
            title: 'Yükleniyor...',
            allowOutsideClick: false,
            didOpen: () => { Swal.showLoading(); }
        });
        fetch('/Home/TumSirketlerHaberleriGetir')
            .then(res => res.json())
            .then(data => {
                let tableHtml = `
                    <div class="table-responsive">
                        <table id="sweetAlertHaberTable" class="display table table-striped modern-table" style="width:100%;">
                            <thead>
                                <tr>
                                    <th>Şirket</th>
                                    <th>Kaynak</th>
                                    <th>Başlık</th>
                                    <th>İşlemler</th>
                                </tr>
                            </thead>
                            <tbody>`;
            let found = false;
            Object.keys(data).forEach(function(sirket) {
                if (data[sirket] && data[sirket].haberler) {
                    Object.keys(data[sirket].haberler).forEach(function(kaynak) {
                        const haberler = data[sirket].haberler[kaynak];
                        if (haberler && haberler.basliklar) {
                            haberler.basliklar.forEach(function(baslik) {
                                if (typeof baslik === 'string' && baslik !== 'Burada bu şirket ile ilgili haber yok') {
                                    found = true;
                                    tableHtml += `<tr>
                                        <td><strong>${sirket}</strong></td>
                                        <td>${kaynak}</td>
                                        <td>${baslik}</td>
                                        <td>
                                            <a href="https://www.google.com/search?q=${encodeURIComponent(sirket + ' ' + baslik)}" target="_blank" class="btn btn-sm btn-primary me-1"><i class="bi bi-link"></i> Habere Git</a>
                                            <button class="btn btn-sm btn-success haber-kaydet-btn" data-sirket="${sirket}" data-baslik="${baslik}" data-url="https://www.google.com/search?q=${encodeURIComponent(sirket + ' ' + baslik)}"><i class="bi bi-save"></i> Ekle</button>
                                            <button class="btn btn-sm btn-warning yapay-zeka-btn" data-sirket="${sirket}" data-baslik="${baslik}" data-url="https://www.google.com/search?q=${encodeURIComponent(sirket + ' ' + baslik)}"><i class="bi bi-robot"></i> Yapay Zekaya Yorumlat!</button>
                                        </td>
                                    </tr>`;
                                }
                            });
                        }
                    });
                }
            });
            tableHtml += `
                        </tbody>
                    </table>
                </div>`;
            if (!found) {
                tableHtml = '<div class="alert alert-info">Hiçbir şirket için haber bulunamadı.</div>';
            }
            Swal.fire({
                icon: found ? 'success' : 'info',
                title: 'Tüm Şirketlerin Haberleri',
                html: tableHtml,
                width: '90%',
                didOpen: () => {
                    if (found) {
                        $('#sweetAlertHaberTable').DataTable({
                            language: {
                                url: 'https://cdn.datatables.net/plug-ins/1.13.6/i18n/tr.json'
                            },
                            responsive: true,
                            paging: true,
                            searching: true,
                            ordering: true,
                            info: true,
                            lengthChange: true,
                            pageLength: 10
                        });
                    }
                }
            });
        })
        .catch(() => {
            Swal.fire({
                icon: 'error',
                title: 'Hata',
                text: 'Haberler alınırken bir hata oluştu.'
            });
        });
    });

    // Add click event for yapay-zeka-btn
    $(document).on('click', '.yapay-zeka-btn', function() {
        const sirketAdi = $(this).data('sirket');
        const haberBaslik = $(this).data('baslik');
        const haberUrl = $(this).data('url');
        Swal.fire({
            title: 'Yapay Zeka Yorumlatılıyor...',
            allowOutsideClick: false,
            didOpen: () => { Swal.showLoading(); }
        });
        $.ajax({
            url: '/Home/YapayZekaYorumlat',
            type: 'POST',
            data: { haberBaslik: haberBaslik },
            success: function(response) {
                if (response.success) {
                    // Yorum geldikten sonra veritabanına ekle
                    $.ajax({
                        url: '/Home/HaberYapayZekaYorumEkle',
                        type: 'POST',
                        data: { haberBaslik: haberBaslik, yorum: response.yorum },
                        success: function(res2) {
                            // İkinci istek başarılıysa kullanıcıya göster
                            Swal.fire({
                                icon: 'success',
                                title: 'Yapay Zeka Yorumu',
                                html: `<div><b>Şirket:</b> ${sirketAdi}<br><b>Başlık:</b> ${haberBaslik}<br><b>URL:</b> <a href='${haberUrl}' target='_blank'>Habere Git</a></div><hr><div style='white-space:pre-line;'>${response.yorum}</div><hr><div style='color:green;font-size:0.95em;'>Yapay zeka yorumu veritabanına kaydedildi.</div>`
                            });
                        },
                        error: function() {
                            Swal.fire({
                                icon: 'warning',
                                title: 'Yapay Zeka Yorumu',
                                html: `<div><b>Şirket:</b> ${sirketAdi}<br><b>Başlık:</b> ${haberBaslik}<br><b>URL:</b> <a href='${haberUrl}' target='_blank'>Habere Git</a></div><hr><div style='white-space:pre-line;'>${response.yorum}</div><hr><div style='color:orange;font-size:0.95em;'>Yapay zeka yorumu veritabanına kaydedilemedi.</div>`
                            });
                        }
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Hata',
                        text: response.message
                    });
                }
            },
            error: function() {
                Swal.fire({
                    icon: 'error',
                    title: 'Hata',
                    text: 'Yapay zeka servisine erişilemedi.'
                });
            }
        });
    });

    // Add click event for haber-kaydet-btn
    $(document).on('click', '.haber-kaydet-btn', function() {
        const sirketAdi = $(this).data('sirket');
        const haberBaslik = $(this).data('baslik');
        const haberUrl = $(this).data('url');
        // Görseli bulmaya çalış (aynı satırdaki imgSrc)
        let haberGorsel = null;
        // Eğer data-imgsrc varsa doğrudan al
        if ($(this).data('imgsrc')) {
            haberGorsel = $(this).data('imgsrc');
        } else {
            // Yoksa, aynı satırdaki img etiketinden bul
            const $tr = $(this).closest('tr');
            const $img = $tr.find('img');
            if ($img.length > 0) {
                haberGorsel = $img.attr('src');
            }
        }
        // Haberi kaydet
        $.ajax({
            url: '/Home/HaberKaydet',
            type: 'POST',
            data: {
                sirketAd: sirketAdi,
                haberBaslik: haberBaslik,
                haberUrl: haberUrl,
                haberGorsel: haberGorsel
            },
            success: function(response) {
                if (response.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Başarılı',
                        text: response.message
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Hata',
                        text: response.message
                    });
                }
            },
            error: function() {
                Swal.fire({
                    icon: 'error',
                    title: 'Hata',
                    text: 'Haber kaydedilirken bir hata oluştu.'
                });
            }
        });
    });
</script>
